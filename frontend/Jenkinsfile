pipeline {
    agent any
    tools {
        nodejs 'node 20.2.0'
    }
    environment {
        DOCKERHUB_CREDENTIALS = credentials('docker_hub_token')
        CREWIN_ENV = credentials('jenkins_crewin_frontend.env') // secretfile ê°€ì ¸ì˜¤ê¸°
    }
    stages {
        stage('Load Environment Variables') {
            steps {
                script {
                    // jenkins_crewin_backend.env íŒŒì¼ ë‚´ìš©ì„ ì  í‚¨ìŠ¤ íŒŒì¼ì˜ í™˜ê²½ ë³€ìˆ˜ë¡œ ë¡œë“œ
                    def props = readProperties file: "${CREWIN_ENV}"
                    env.MATTERMOST_CHANNEL_NAME = props.MATTERMOST_CHANNEL_NAME
                    env.MATTERMOST_WEBHOOK_URL = props.MATTERMOST_WEBHOOK_URL
                    env.DOCKER_CONTAINER_NAME = props.DOCKER_CONTAINER_NAME
                    env.DIST_PATH = props.DIST_PATH
                    env.REMOVE_PREFIX = props.REMOVE_PREFIX
                    env.HOST_PATH = props.HOST_PATH
                }
            }
        }
        stage('Notify Build Start') {
            steps {
                script {
                    def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                    def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                    def Commit_Message = sh(script: "git log -1 --pretty=%B", returnStdout: true).trim()
                    
                    // ëª¨ë“  ì»¤ë°‹ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
                    def allCommits = sh(script: "git log --pretty=format:'%h - %s (%an)' ${env.GIT_PREVIOUS_SUCCESSFUL_COMMIT}..HEAD", returnStdout: true).trim()
                    def formattedCommits = allCommits.split('\n').collect { "â€¢ ${it}" }.join('\n')

                    def message = """
                        #### ğŸ‘¨â€ğŸ’»FE ë¹Œë“œ ì‹œì‘
                        **ë¹Œë“œ ë²ˆí˜¸** ${env.JOB_NAME} #${env.BUILD_NUMBER}
                        **ë¸Œëœì¹˜:** ${env.GIT_BRANCH}
                        **ì‘ì„±ì:** ${Author_ID} (${Author_Name})
                        **ë¹Œë“œ URL:** [Details](${env.BUILD_URL})
                        **í¬í•¨ëœ ì»¤ë°‹:**
                        ${formattedCommits}
                    """.stripIndent()
                    mattermostSend(
                        color: '#439FE0',
                        message: message,
                        endpoint: "${env.MATTERMOST_WEBHOOK_URL}",
                        channel: "${env.MATTERMOST_CHANNEL_NAME}",
                        icon: 'https://jenkins.io/images/logos/jenkins/jenkins.png'  // Jenkins ë¡œê³  URL
                    )
                }
            }
        }
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        stage('Prepare Config') {
            steps {
                withCredentials([file(credentialsId: 'crewin-front-env', variable: 'CONFIG_FILE')]) {
                    sh '''
                        chmod -R 755 frontend
                        cp $CONFIG_FILE frontend/.env
                    '''
                }
            }
        }
        stage('Build') {
            steps {
                script {
                    sh '''
                        cd frontend
                        rm package-lock.json
                        npm install rollup @rollup/plugin-node-resolve @rollup/plugin-commonjs
                        npm install esbuild
                        npm install
                        npm run build
                        chmod -R 755 dist
                        ls -al dist
                    '''
                }
            }
        }
        stage('Transfer') {
            steps {
                script {
                    sh '''
                        cd frontend/dist
                        ls -la
                    ''' // íŒŒì¼ì´ ë¹Œë“œ ë””ë ‰í† ë¦¬ì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                }
                sshPublisher(
                    publishers: [
                        sshPublisherDesc(
                            configName: 'Gumi-Server',
                            transfers: [
                                sshTransfer(
                                    sourceFiles: "${DIST_PATH}",
                                    removePrefix: "${REMOVE_PREFIX}",
                                    remoteDirectory: "${HOST_PATH}",
                                )
                            ],
                            usePromotionTimestamp: false,
                            alwaysPublishFromMaster: false
                        )
                    ]
                )
            }
        }
        stage('Deploy') {
            steps {
                script {
                    sh "docker restart ${DOCKER_CONTAINER_NAME}"
                }
            }
        }
    }

    post {
        always {
            script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                def Commit_Message = sh(script: "git log -1 --pretty=%B", returnStdout: true).trim()
                def Build_Status = currentBuild.result ?: 'SUCCESS'
                def Status_Color = Build_Status == 'SUCCESS' ? 'good' : (Build_Status == 'UNSTABLE' ? 'warning' : 'danger')
                def Status_Text = Build_Status == 'SUCCESS' ? 'ë¹Œë“œ ì„±ê³µ' : (Build_Status == 'UNSTABLE' ? 'ë¹Œë“œ ë¶ˆì•ˆì •' : 'ë¹Œë“œ ì‹¤íŒ¨')
    
                // ëª¨ë“  ì»¤ë°‹ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
                def allCommits = sh(script: "git log --pretty=format:'%h - %s (%an)' ${env.GIT_PREVIOUS_SUCCESSFUL_COMMIT}..HEAD", returnStdout: true).trim()
                def formattedCommits = allCommits.split('\n').collect { "â€¢ ${it}" }.join('\n')

                def message = """
                    #### ğŸ‘¨â€ğŸ’»FE ${Status_Text}
                    **ë¹Œë“œ ë²ˆí˜¸** ${env.JOB_NAME} #${env.BUILD_NUMBER}
                    **ë¸Œëœì¹˜:** ${env.GIT_BRANCH}
                    **ì‘ì„±ì:** ${Author_ID} (${Author_Name})
                    **ë¹Œë“œ URL:** [Details](${env.BUILD_URL})
                    **í¬í•¨ëœ ì»¤ë°‹:**
                    ${formattedCommits}
                """.stripIndent()

                mattermostSend(
                    color: Status_Color,
                    message: message,
                    endpoint: "${env.MATTERMOST_WEBHOOK_URL}",
                    channel: "${env.MATTERMOST_CHANNEL_NAME}",
                    icon: 'https://jenkins.io/images/logos/jenkins/jenkins.png'
                )
            }
        }
    }
}